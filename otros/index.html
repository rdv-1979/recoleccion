<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa colaborativo de reciclaje</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
    #sidebar {
      width: 100px;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 10px;
      border-right: 2px solid #ccc;
    }
    #sidebar img {
      width: 48px;
      height: 48px;
      margin: 10px;
      cursor: grab;
      transition: transform 0.2s;
    }
    #sidebar img:hover {
      transform: scale(1.1);
    }
    #map {
      flex: 1;
    }
  </style>
</head>
<body>

  <!-- Barra lateral -->
  <div id="sidebar">
    <img src="icons/organica.png" draggable="true" data-tipo="orgánica" alt="Orgánica">
    <img src="icons/papel.png" draggable="true" data-tipo="papel" alt="Papel">
    <img src="icons/metal.png" draggable="true" data-tipo="metal" alt="Metal">
  </div>

  <!-- Contenedor del mapa -->
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    const mapContainer = document.getElementById('map');
    const sidebar = document.getElementById('sidebar');
    let draggedType = null;

    // --- 1️⃣ Inicializar el mapa una vez que tengamos ubicación
    function iniciarMapa(lat, lon) {
      map = L.map('map').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      activarDragAndDrop(); // Habilita los eventos de los marcadores
    }

    // --- 2️⃣ Intentar obtener ubicación real
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          console.log(`Ubicación detectada: ${lat}, ${lon}`);
          iniciarMapa(lat, lon);
        },
        err => {
          console.warn('Error al obtener ubicación:', err.message);
          iniciarMapa(-34.6, -58.4); // Coordenadas de respaldo (Buenos Aires)
        }
      );
    } else {
      console.warn('Geolocalización no soportada por este navegador.');
      iniciarMapa(-34.6, -58.4);
    }

    // --- 3️⃣ Función principal de drag & drop
    function activarDragAndDrop() {
      // Arrastre desde barra lateral
      document.querySelectorAll('#sidebar img').forEach(img => {
        img.addEventListener('dragstart', e => {
          draggedType = e.target.getAttribute('data-tipo');
        });
      });

      // Permitir drop sobre el mapa
      mapContainer.addEventListener('dragover', e => e.preventDefault());
      mapContainer.addEventListener('drop', e => {
        e.preventDefault();
        const rect = mapContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const latlng = map.containerPointToLatLng([x, y]);

        const icon = L.icon({
          iconUrl: getIconURL(draggedType),
          iconSize: [40, 40]
        });

        const marker = L.marker(latlng, { icon, draggable: true }).addTo(map);
        marker.bindPopup(`<b>${draggedType}</b><br>Lat: ${latlng.lat.toFixed(6)}<br>Lng: ${latlng.lng.toFixed(6)}`).openPopup();

        // Preguntar confirmación al crear
        if (confirm(`¿Deseas guardar la posición del marcador ${draggedType}?`)) {
          console.log('Guardando marcador:', draggedType, latlng);
        }

        // Cuando el usuario mueve el marcador
        marker.on('dragend', e => {
          const newPos = e.target.getLatLng();
          const markerPoint = map.latLngToContainerPoint(newPos);
          const sidebarRect = sidebar.getBoundingClientRect();

          // Si se arrastra a la barra lateral → eliminar
          if (
            markerPoint.x < 0 ||
            (e.originalEvent && e.originalEvent.clientX < sidebarRect.right)
          ) {
            if (confirm('¿Deseas eliminar este marcador?')) {
              map.removeLayer(marker);
              return;
            }
          }

          // Confirmar nueva posición
          if (confirm(`¿Guardar nueva posición?\nLat: ${newPos.lat.toFixed(6)}\nLng: ${newPos.lng.toFixed(6)}`)) {
            console.log('Nueva posición guardada:', newPos);
          }
        });
      });

      // Permitir drop sobre la barra lateral
      sidebar.addEventListener('dragover', e => e.preventDefault());
      sidebar.addEventListener('drop', e => {
        e.preventDefault();
        console.log('Drop sobre la barra — cancelado.');
      });
    }

    // --- 4️⃣ Función auxiliar: obtener ícono por tipo
    function getIconURL(tipo) {
      switch (tipo) {
        case 'orgánica': return 'icons/organica.png';
        case 'papel': return 'icons/papel.png';
        case 'metal': return 'icons/metal.png';
        default: return 'icons/default.png';
      }
    }
  </script>
</body>
</html>
